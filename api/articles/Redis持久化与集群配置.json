{"title":"Redis持久化与集群配置","slug":"Redis持久化与集群配置","date":"2023-04-16T07:40:28.000Z","updated":"2023-04-16T08:23:04.097Z","comments":true,"path":"api/articles/Redis持久化与集群配置.json","photos":[],"link":"","excerpt":null,"covers":null,"content":"<div class=\"toc\">\n\n<!-- toc -->\n\n<ul>\n<li><a href=\"#shi-yan-huan-jing\">实验环境</a></li>\n<li><a href=\"#shi-yan-bu-zou\">实验步骤</a><ul>\n<li><a href=\"#yi-redis-chi-jiu-hua\">一、Redis持久化</a></li>\n<li><a href=\"#er-redis-zhu-cong-fu-zhi\">二、Redis主从复制</a></li>\n<li><a href=\"#san-redis-shao-bing-mo-shi-de-qi-yong\">三、Redis哨兵模式的启用</a></li>\n<li><a href=\"#si-guan-xi-xing-shu-ju-ku-zhong-biao-zai-redis-zhong-de-she-ji-yu-cun-chu\">四、关系型数据库中表在Redis中的设计与存储</a></li>\n<li><a href=\"#wu-redis-xiao-xi-gong-neng\">五、Redis消息功能</a></li>\n</ul>\n</li>\n<li><a href=\"#yu-dao-de-wen-ti\">遇到的问题</a></li>\n<li><a href=\"#can-kao\">参考</a></li>\n</ul>\n<!-- tocstop -->\n\n</div>\n\n<h1><span id=\"shi-yan-huan-jing\">实验环境</span><a href=\"#shi-yan-huan-jing\" class=\"header-anchor\">#</a></h1><p><strong>服务器环境</strong></p>\n<ul>\n<li>Ubuntu 20.04.4</li>\n<li>Redis 7.0.9</li>\n</ul>\n<p><strong>服务器ip</strong></p>\n<p>Master032004134: 192.168.50.98</p>\n<p>Slave032004134: 192.168.50.99</p>\n<h1><span id=\"shi-yan-bu-zou\">实验步骤</span><a href=\"#shi-yan-bu-zou\" class=\"header-anchor\">#</a></h1><h2><span id=\"yi-redis-chi-jiu-hua\">一、Redis持久化</span><a href=\"#yi-redis-chi-jiu-hua\" class=\"header-anchor\">#</a></h2><p>开启RDB和AOF</p>\n<p>按照以下配置修改配置文件：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># file: redis.conf</span><br><span class=\"line\"># open AOF</span><br><span class=\"line\">appendonly yes</span><br></pre></td></tr></table></figure>\n\n<p>存入以下键值</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">redis-cli</span></span><br><span class=\"line\">set SID 032004134</span><br><span class=\"line\">set Time 202304141941</span><br></pre></td></tr></table></figure>\n\n<p>使用命令，强制Redis保存RDB和AOF</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">redis-cli</span></span><br><span class=\"line\">BGSAVE # 强制通过异步方式保存RDB</span><br><span class=\"line\">BGREWRITEAOF # 重写AOF</span><br></pre></td></tr></table></figure>\n\n<p>将刚刚电脑A上Redis服务器保存的RDB和AOF文件拷入电脑B，配置电脑B上Redis服务器的conf文件，使得在电脑B上的Redis服务器可以通过电脑A上Redis服务器的AOF和RDB文件恢复数据（做两次，先只拷入电脑A的AOF文件在电脑B上恢复一次数据；接着删除B上的AOF文件，尝试用电脑A的RDB文件再在电脑B上使用RDB文件恢复一次）</p>\n<p>同步文件<code>rsync -av redis-stable Slave032004134:/usr/local/</code></p>\n<p>在拥有AOF和RDB的状态下启动Redis</p>\n<p>删除aof目录下的增量aof文件，并且修改<strong>appendonly.aof.manifest</strong>文件，令其保留第一行</p>\n<p>在只有RDB的状态下启动Redis</p>\n<p>查看电脑B上Redis服务器此时的SID与Time的值是否与电脑A的Redis服务器的值一致</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">redis-cli</span></span><br><span class=\"line\">get SID</span><br><span class=\"line\">get Time</span><br></pre></td></tr></table></figure>\n\n<h2><span id=\"er-redis-zhu-cong-fu-zhi\">二、Redis主从复制</span><a href=\"#er-redis-zhu-cong-fu-zhi\" class=\"header-anchor\">#</a></h2><p>其中，关闭master的RDB和AOF，并开启slave1,slave2,slave3的RDB和AOF（注意几个服务器的AOF和RDB的文件名<strong>不要重名</strong>了），从服务器均为<strong>只读</strong></p>\n<p>集群信息:</p>\n<ul>\n<li>Master：Master032004134:6379</li>\n<li>Slave1：Slave032004134:6380</li>\n<li>Slave2：Slave032004134:6381</li>\n<li>Slave3：Slave032004134:6382</li>\n</ul>\n<p>配置Master服务器上的配置文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Master032004134:3079</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">正常在集群中不应该关闭主节点的AOF和RDB</span></span><br><span class=\"line\">appendonly no</span><br><span class=\"line\">save &quot;&quot;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">关闭保护模式，以允许非本地连接</span></span><br><span class=\"line\">protected-mode no</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">关闭<span class=\"built_in\">bind</span>，这样子可以监听所有的请求</span></span><br><span class=\"line\">即注释掉 bind Slave032004134 -::1</span><br></pre></td></tr></table></figure>\n\n<p>配置Slave服务器上的配置文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">通用配置</span></span><br><span class=\"line\">replicaof Master032004134 6379</span><br><span class=\"line\">replica-read-only yes</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">slave独立配置，替换端口就好</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">使用:%s/old/new/gc进行批量替换</span></span><br><span class=\"line\">port 6382</span><br><span class=\"line\">pidfile /var/run/redis_6382.pid</span><br><span class=\"line\">logfile &quot;/usr/local/redis-stable/log/log_6382.txt&quot;</span><br><span class=\"line\">dbfilename dump_6382.rdb</span><br><span class=\"line\">appendfilename &quot;appendonly_6382.aof&quot;</span><br></pre></td></tr></table></figure>\n\n<p>启动主节点，启动从节点</p>\n<p>在6379服务器设置键值site，值为<a href=\"http://www.baidu.com,观察6380、6381、6382是否可以读取到site/\">www.baidu.com，观察6380、6381、6382是否可以读取到site</a></p>\n<p>在master的redis-cli输入：<code>set site www.baidu.com</code></p>\n<p>观察6380、6381、6382是否可以读取到site</p>\n<p>假定Master服务器突然宕机（直接用shutdown关闭），手动输入命令将127.0.0.1:6380设为新的Master服务器:6381和6382改为127.0.0.1:6380的从服务器</p>\n<p>执行以下命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Redis-Cli</span><br><span class=\"line\"># 在6381和6382上</span><br><span class=\"line\">REPLICAOF Slave032004134 6380</span><br><span class=\"line\"># 查看主从状态</span><br><span class=\"line\">INFO replication</span><br></pre></td></tr></table></figure>\n\n<h2><span id=\"san-redis-shao-bing-mo-shi-de-qi-yong\">三、Redis哨兵模式的启用</span><a href=\"#san-redis-shao-bing-mo-shi-de-qi-yong\" class=\"header-anchor\">#</a></h2><p>重新恢复上述服务器之间的主从关系</p>\n<p>给6379和6381都设置登录密码：passwd，配置6380、6381和6382服务器使其仍能与6379同步</p>\n<p>配置Sentinel哨兵模式监视Master（只需要一个哨兵），并且配置服务器的优先级，使得Master宕机后由127.0.0.1:6381接替Master，127.0.0.1:6380和6382改为127.0.0.1:6381的从服务器，配置完成后，启动哨兵模式，关闭6379服务器，观察整个过程是否成功</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置6379 sentinel.conf</span></span><br><span class=\"line\">daemonize yes</span><br><span class=\"line\">logfile &quot;/usr/local/redis-stable/log/log-sentinel.txt&quot;</span><br><span class=\"line\">sentinel monitor mymaster 192.168.50.98 6379 1</span><br><span class=\"line\">sentinel auth-pass mymaster 3079</span><br><span class=\"line\">sentinel down-after-milliseconds mymaster 1000</span><br><span class=\"line\">sentinel failover-timeout mymaster 10000</span><br><span class=\"line\">sentinel parallel-syncs mymaster 1</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置6379</span></span><br><span class=\"line\">requirepass 3079</span><br><span class=\"line\">masterauth 3079</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置6380</span></span><br><span class=\"line\">masterauth 3079</span><br><span class=\"line\">注释掉bind</span><br><span class=\"line\">关闭保护模式</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置6381</span></span><br><span class=\"line\">requirepass 3079</span><br><span class=\"line\">masterauth 3079</span><br><span class=\"line\">replica-priority 10</span><br><span class=\"line\">注释掉bind</span><br><span class=\"line\">关闭保护模式</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置6382</span> </span><br><span class=\"line\">masterauth 3079</span><br><span class=\"line\">注释掉bind</span><br><span class=\"line\">关闭保护模式</span><br></pre></td></tr></table></figure>\n\n<h2><span id=\"si-guan-xi-xing-shu-ju-ku-zhong-biao-zai-redis-zhong-de-she-ji-yu-cun-chu\">四、关系型数据库中表在Redis中的设计与存储</span><a href=\"#si-guan-xi-xing-shu-ju-ku-zhong-biao-zai-redis-zhong-de-she-ji-yu-cun-chu\" class=\"header-anchor\">#</a></h2><p>根据文档“redis中关系型表的存储规范”介绍的方法将下表以键值形式存储：</p>\n<p>Key名: “表名:主键名:主键的值:列名”  </p>\n<p>Value:  列值</p>\n<table>\n<thead>\n<tr>\n<th>ID</th>\n<th>Name</th>\n<th>English</th>\n<th>Math</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>zhangsan</td>\n<td>69</td>\n<td>86</td>\n</tr>\n<tr>\n<td>2</td>\n<td>Lisi</td>\n<td>69</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">redis-cli</span></span><br><span class=\"line\">set student:ID:1:Name zhangsan</span><br><span class=\"line\">set student:ID:1:English 69</span><br><span class=\"line\">set student:ID:1:Math 86</span><br><span class=\"line\"></span><br><span class=\"line\">set student:ID:2:Name Lisi</span><br><span class=\"line\">set student:ID:2:English 69</span><br><span class=\"line\">set student:ID:2:Math 100</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">冗余存储</span></span><br><span class=\"line\">sadd student:Name:zhangsan:ID 1</span><br><span class=\"line\">sadd student:English:69:ID 1</span><br><span class=\"line\">sadd student:Math:86:ID 1</span><br><span class=\"line\"></span><br><span class=\"line\">sadd student:Name:Lisi:ID 2</span><br><span class=\"line\">sadd student:English:69:ID 2</span><br><span class=\"line\">sadd student:Math:100:ID 2</span><br></pre></td></tr></table></figure>\n\n<p>在redis数据库执行以下查找</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查找数学成绩为86的学生ID</span></span><br><span class=\"line\">smembers student:Math:86:ID</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查找数学成绩为100的学生姓名</span></span><br><span class=\"line\">smembers student:Math:100:ID</span><br><span class=\"line\">get student:ID:2:Name</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查找英语成绩为69且数学成绩为100的学生姓名</span></span><br><span class=\"line\">sinter student:English:69:ID student:Math:100:ID</span><br><span class=\"line\">get student:ID:2:Name</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查找英语成绩为69或者数学成绩为86的学生姓名</span></span><br><span class=\"line\">sunion student:English:69:ID student:Math:86:ID</span><br><span class=\"line\">get student:ID:2:Name</span><br><span class=\"line\">get student:ID:1:Name</span><br></pre></td></tr></table></figure>\n\n<h2><span id=\"wu-redis-xiao-xi-gong-neng\">五、Redis消息功能</span><a href=\"#wu-redis-xiao-xi-gong-neng\" class=\"header-anchor\">#</a></h2><p>1、开启三个客户端，A客户端负责在频道发送各个城市的天气信息，频道名分别为City_Beijing、City_Shanghai和City_Guangzhou，B和C客户端负责接收频道信息</p>\n<p>执行以下命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在B客户端输入命令令其订阅北京的天气信息</span></span><br><span class=\"line\">subscribe City_Beijing</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">使用通配符，让C客户端接收所有城市的天气信息</span></span><br><span class=\"line\">Psubscribe City_*</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">A客户端，在City_Beijing频道发送sunny，在City_Shanghai频道发送cloudy，在City_Guangzhou发送rainy，观察客户端B，C接收情况</span></span><br><span class=\"line\">publish City_Beijing sunny</span><br><span class=\"line\">publish City_Shanghai cloudy</span><br><span class=\"line\">publish City_Guangzhou rainy</span><br></pre></td></tr></table></figure>\n\n\n\n<h1><span id=\"yu-dao-de-wen-ti\">遇到的问题</span><a href=\"#yu-dao-de-wen-ti\" class=\"header-anchor\">#</a></h1><ol>\n<li><p>redis 没有按照配置文件的配置运行在后台</p>\n<p>要在命令后面加上配置文件，redis服务器才会像配置文件中的配置一样运行。</p>\n</li>\n<li><p>Error condition on socket for SYNC: Connection refused</p>\n<ol>\n<li><strong>mode</strong>&#x3D;standlone,没有开启Redis的集群模式</li>\n<li><strong>bind</strong>设置为监听127.0.0.1的所有端口，所以监听端口只有监听本地的端口，不能监听到从服务器的端口</li>\n<li>master处于<strong>protected</strong>模式，只能接收本地的连接</li>\n</ol>\n</li>\n<li><p>redis-cli报错<code>CLUSTERDOWN Hash slot not served</code></p>\n<p>通常表示 Redis 集群中的某些节点不可用或当前节点与其他节点之间的网络连接发生了故障。</p>\n<p>因为我的集群只有一个主节点，但是Redis集群至少要求要3个主节点</p>\n</li>\n<li><p>redis配置密码却没有生效</p>\n<p>配置文件最后一行<code>user default on nopass ~* &amp;* +@all</code>导致</p>\n</li>\n<li><p>哨兵模式无法选择从节点作为新的主节点</p>\n<p>因为主从节点在不同的服务器上，从节点没有配置可以监听其他服务器的请求，所以哨兵无法连接到从节点，导致无法选择从节点作为新的主节点</p>\n</li>\n<li><p>开启哨兵模式后，从节点挂了</p>\n<p>因为哨兵模式开启后，回去修改从节点的配置文件，而本来的主节点的ip设置的是127.0.0.1，然后导致从节点的配置中，主节点的ip变成了127.0.0.1，但主从节点并没有在同一台服务器内，所以无法同信。</p>\n</li>\n</ol>\n<h1><span id=\"can-kao\">参考</span><a href=\"#can-kao\" class=\"header-anchor\">#</a></h1><ol>\n<li><a href=\"https://redis.io/docs/management/replication\">https://redis.io/docs/management/replication</a></li>\n<li><a href=\"https://redis.io/docs/management/persistence\">https://redis.io/docs/management/persistence</a></li>\n<li><a href=\"https://blog.csdn.net/RougeK/article/details/108815028\">(97条消息) Redis三种集群方式安装及配置_redis集群配置_Rouge丶铠的博客-CSDN博客</a></li>\n</ol>\n","categories":[{"name":"Redis","slug":"Redis","count":1,"path":"api/categories/Redis.json"}],"tags":[{"name":"Redis","slug":"Redis","count":1,"path":"api/tags/Redis.json"},{"name":"AOF","slug":"AOF","count":1,"path":"api/tags/AOF.json"},{"name":"RDB","slug":"RDB","count":1,"path":"api/tags/RDB.json"},{"name":"哨兵模式","slug":"哨兵模式","count":1,"path":"api/tags/哨兵模式.json"},{"name":"主从模式","slug":"主从模式","count":1,"path":"api/tags/主从模式.json"},{"name":"消息订阅","slug":"消息订阅","count":1,"path":"api/tags/消息订阅.json"}]}